<script>
    let details = [];
    let total = 0;

    function add_product_to_details() {
        let product_selected = document.getElementById("product_select").value;
        let detail_quantity = document.getElementById("detail_quantity").value;
        $.ajax({
            type: "POST",
            url: "/add_detail_to_order_purchase/",
            data: {
                "product_id": product_selected,
                "detail_quantity": detail_quantity
            },
            success: function (data) {
                total += parseFloat(data['detail_total']);
                $('#details_table tbody').append("<tr><td>" + data['product_name'] + "</td><td>" + data['detail_quantity'] + "</td><td>" + data['detail_total'] + "</td></tr>");

                document.getElementById("summary_purchase").innerText = total;
                document.getElementById("detail_quantity").value = 1;
                $('#add-product').modal('hide');
                details.push(data);
                document.getElementById("details_hidden").value = JSON.stringify(details);
                document.getElementById("purchase_total").value = total;
            }
        });
    }
</script>
{% extends 'Facturacion/base.html' %} {% block contenido %}
    <div class="right_col" role="main">
        <div class="row">
            <div class="col-md-12 col-sm-12 col-xs-12">
                <div class="x_panel fondo-radial">
                    <div class="x_title">
                        <h2 class="efecto1">Nueva Orden de Compra</h2>
                        <ul class="nav navbar-right panel_toolbox">
                            <li>
                                <a class="collapse-link"><i class="fa fa-chevron-up"></i></a>
                            </li>
                        </ul>
                        <div class="clearfix"></div>
                    </div>
                    {% if messages %}
                        <div class="col-md-12col-sm-12 col-xs-12 " style="    color: #a82823;" align=" left">
                            <ul class="messages">
                                {% for message in messages %}
                                    <li {% if message.tags %} class="{{ message.tags }}" {% endif %} >
                                        {{ message }}
                                    </li>
                                {% endfor %}
                            </ul>
                        </div>
                    {% endif %}
                    <div class="x_content">
                        <form id="create-order-purchase-form" method="POST" action="{% url 'crear_orden_compra' %}">
                            {% csrf_token %}
                            <input type="hidden" id="details_hidden" name="details_hidden"
                                   class="form-control col-sm-4">
                            <input type="hidden" id="purchase_total" name="purchase_total">
                            <div class="form-group row">
                                <label class="col-sm-8">Nro. Compra</label>
                                <input type="number" id="order_number" name="order_number" class="form-control col-sm-4"
                                       value="">
                            </div>
                            <div class="form-group row">
                                <label class="col-sm-8">Num. Factura</label>
                                <input type="number" id="invoice_number" name="invoice_number"
                                       class="form-control col-sm-4"
                                       value="">
                            </div>
                            <div class="form-group row">
                                <label class="col-sm-8">Fecha de Compra</label>
                                <input type="date" id="purchase_date" name="purchase_date" class="form-control col-sm-4"
                                >
                            </div>
                            <div class="form-group row">
                                <label class="col-sm-8">Proveedor</label>
                                <select id="provider_select" name="provider_select"
                                        class="form-control col-sm-10">
                                    {% for provider in providers %}
                                        <option value="{{ provider.id }}">{{ provider.nombre_responsable }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            Información del pago
                            <br/><br/>
                            <div class="form-group row">
                                <label class="col-sm-8">Forma de Pago</label>
                                <select id="how_to_pay_select" name="how_to_pay_select"
                                        class="form-control col-sm-10">
                                    {% for how_to_pay in how_to_pay_list %}
                                        <option value="{{ how_to_pay }}">{{ how_to_pay }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="form-group row">
                                <label class="col-sm-8">Plazo (meses)</label>
                                <input type="number" id="payment_deadline" name="payment_deadline"
                                       class="form-control col-sm-4">
                            </div>
                            <div class="form-group row">
                                <label class="col-sm-8">Fecha de Límite</label>
                                <input type="date" id="date_limit_to_pay" name="date_limit_to_pay"
                                       class="form-control col-sm-4">
                            </div>
                            <div class="form-group row">
                                <label class="col-sm-8">Estado</label>
                                <select id="status" name="status"
                                        class="form-control col-sm-10">
                                    {% for st in status %}
                                        <option value="{{ st }}">{{ st }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="clearfix"></div>
                            <h2 class="efecto1">Detalles</h2>
                            <div class="form-group row">
                                <button type="button" class="btn btn-primary" data-toggle="modal"
                                        data-target="#add-product">
                                    Agregar Detalle
                                </button>
                            </div>
                            <div class="form-group row">
                                <table id="details_table" data-name="details_table"
                                       class="table table-striped table-condensed">
                                    <thead>
                                    <tr>
                                        <th>Producto</th>
                                        <th>Cantidad</th>
                                        <th>Total</th>
                                    </tr>
                                    </thead>
                                    <tbody>
                                    </tbody>
                                    <tfoot>
                                    <tr>
                                        <td></td>
                                        <th>Total:</th>
                                        <td id="summary_purchase">0.0</td>
                                    </tr>
                                    </tfoot>
                                </table>
                            </div>
                            <div class="form-group row">
                                <input id="create-button" class="btn btn-primary" type="submit" value="Grabar">
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="add-product" tabindex="-1" role="dialog" aria-labelledby="add-product"
         aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="add-product">Agregar Producto</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-12 col-sm-12 col-xs-12">
                            <div class="form-group row">
                                <label class="col-sm-8">Producto</label>
                                <select id="product_select" name="product_select"
                                        class="form-control col-sm-10">
                                    {% for product in products %}
                                        <option value="{{ product.id }}">{{ product.nombre_producto }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <label class="col-sm-8">Cantidad</label>
                            <input type="number" id="detail_quantity" name="detail_quantity" value="1"
                                   class="form-control col-sm-4">
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
                    <button type="button" onclick="add_product_to_details()" class="btn btn-primary">Agregar</button>
                </div>
            </div>
        </div>
    </div>
{% endblock contenido %}